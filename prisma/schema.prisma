// E-school MS - Comprehensive Prisma Schema for PostgreSQL
// Optimized for Production with Focus on Staff/Admin RBAC

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ==========================================
// ENUMS
// ==========================================

enum UserStatus {
  ACTIVE
  SUSPENDED
  INACTIVE
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  EXCUSED
}

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

enum PaymentStatus {
  PAID
  PENDING
  PARTIAL
  OVERDUE
  REFUNDED
}

enum PaymentMethod {
  CASH
  BANK_TRANSFER
  CREDIT_CARD
  MOBILE_MONEY
  CHECK
}

enum NotificationType {
  SYSTEM
  ACADEMIC
  FINANCE
  EXAM
}

enum LogLevel {
  INFO
  WARN
  ERROR
  CRITICAL
}

// ==========================================
// üîê AUTH & USER MANAGEMENT
// ==========================================

model User {
  id              String           @id @default(cuid())
  firstName       String
  lastName        String
  email           String           @unique
  phone           String?          @unique
  passwordHash    String?
  emailVerified   Boolean          @default(false)
  verificationToken String?        @unique
  resetPasswordToken String?       @unique
  resetPasswordExpiry DateTime?
  status          UserStatus       @default(ACTIVE)
  lastLogin       DateTime?
  isActive        Boolean          @default(true)
  deletedAt       DateTime?
  createdBy       String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  roles           UserRole[]
  sessions        Session[]
  activityLogs    UserActivityLog[]
  auditLogs       AuditLog[]
  createdByUser   User?            @relation("UserCreatedBy", fields: [createdBy], references: [id])
  createdUsers    User[]          @relation("UserCreatedBy")
  
  // Specific Entity Relations
  teacher         Teacher?

  @@index([email])
  @@index([createdBy])
}

model Role {
  id              String           @id @default(cuid())
  name            String           @unique
  description     String?
  permissions     RolePermission[]
  users           UserRole[]
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
}

model Permission {
  id              String           @id @default(cuid())
  action          String           // CREATE, READ, UPDATE, DELETE
  subject         String           // e.g., "SCHOOL_PROFILE", "ACADEMIC_YEAR"
  roles           RolePermission[]
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@unique([action, subject])
}

model RolePermission {
  id              String     @id @default(cuid())
  roleId          String
  permissionId    String
  role            Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission      Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
}

model UserRole {
  id              String     @id @default(cuid())
  userId          String
  roleId          String
  user            User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  role            Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
}

model Session {
  id              String     @id @default(cuid())
  userId          String
  token           String     @unique
  expiresAt       DateTime
  user            User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt       DateTime   @default(now())
}

// ==========================================
// üè´ SCHOOL SETTINGS
// ==========================================

model SchoolProfile {
  id              String     @id @default(cuid())
  schoolName      String
  logo            String?
  address         String
  phone           String
  email           String
  website         String?
  principalName   String
  updatedAt       DateTime   @updatedAt
}

model AcademicYear {
  id              String     @id @default(cuid())
  name            String     @unique // e.g., "2023-2024"
  startDate       DateTime
  endDate         DateTime
  isCurrent       Boolean    @default(false)
  terms           Term[]
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
}

model Term {
  id              String       @id @default(cuid())
  name            String       // e.g., "First Term"
  academicYearId  String
  startDate       DateTime
  endDate         DateTime
  academicYear    AcademicYear @relation(fields: [academicYearId], references: [id])
  exams           Exam[]
}

model SystemSetting {
  id              String     @id @default(cuid())
  key             String     @unique
  value           String
  description     String?
}

model BackupLog {
  id              String     @id @default(cuid())
  fileName        String
  fileSize        Int
  status          String     // SUCCESS, FAILED
  error           String?
  createdAt       DateTime   @default(now())
}

// ==========================================
// üéì ACADEMIC MANAGEMENT
// ==========================================

model Class {
  id              String       @id @default(cuid())
  name            String       @unique
  level           Int?         // Numeric grade level
  sections        Section[]
  subjects        Subject[]
  feeStructures   FeeStructure[]
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
}

model Section {
  id              String       @id @default(cuid())
  name            String
  classId         String
  class           Class        @relation(fields: [classId], references: [id])
  classTeachers   ClassTeacher[]
  timetables      Timetable[]

  @@unique([name, classId])
}

model Subject {
  id              String       @id @default(cuid())
  name            String
  code            String       @unique
  classId         String
  class           Class        @relation(fields: [classId], references: [id])
  teachers        Teacher[]    @relation("TeacherSubjects")
  examSubjects    ExamSubject[]
  periods         TimetablePeriod[]
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
}

model Teacher {
  id              String       @id @default(cuid())
  userId          String       @unique
  user            User         @relation(fields: [userId], references: [id])
  employeeId      String       @unique
  qualification   String?
  specialization  String?
  subjects        Subject[]    @relation("TeacherSubjects")
  classTeacherOf  ClassTeacher[]
  timetables      Timetable[]
  attendance      Attendance[]
}

model ClassTeacher {
  id              String     @id @default(cuid())
  teacherId       String
  sectionId       String
  teacher         Teacher    @relation(fields: [teacherId], references: [id])
  section         Section    @relation(fields: [sectionId], references: [id])

  @@unique([teacherId, sectionId])
}

// ==========================================
// üìÖ ACADEMIC OPERATIONS
// ==========================================

model AcademicCalendar {
  id              String     @id @default(cuid())
  title           String
  description     String?
  startDate       DateTime
  endDate         DateTime
  isHoliday       Boolean    @default(false)
  createdAt       DateTime   @default(now())
}

model Timetable {
  id              String            @id @default(cuid())
  sectionId       String
  teacherId       String
  day             DayOfWeek
  section         Section           @relation(fields: [sectionId], references: [id])
  teacher         Teacher           @relation(fields: [teacherId], references: [id])
  periods         TimetablePeriod[]
}

model TimetablePeriod {
  id              String     @id @default(cuid())
  timetableId     String
  subjectId       String
  startTime       String     // e.g., "08:00"
  endTime         String     // e.g., "09:00"
  timetable       Timetable  @relation(fields: [timetableId], references: [id])
  subject         Subject    @relation(fields: [subjectId], references: [id])
}

model Attendance {
  id              String             @id @default(cuid())
  date            DateTime           @default(now())
  recordedBy      String?            // Teacher ID
  teacher         Teacher?           @relation(fields: [recordedBy], references: [id])

  @@index([date])
}

// ==========================================
// üìù EXAMS & RESULTS
// ==========================================

model Exam {
  id              String        @id @default(cuid())
  name            String
  termId          String
  startDate       DateTime
  endDate         DateTime
  term            Term          @relation(fields: [termId], references: [id])
  examSubjects    ExamSubject[]
}

model ExamSubject {
  id              String     @id @default(cuid())
  examId          String
  subjectId       String
  examDate        DateTime
  maxMarks        Int
  minMarks        Int
  exam            Exam       @relation(fields: [examId], references: [id])
  subject         Subject    @relation(fields: [subjectId], references: [id])

  @@unique([examId, subjectId])
}

model Grade {
  id              String     @id @default(cuid())
  name            String     // A, B, C, etc.
  minPercentage   Float
  maxPercentage   Float
  point           Float?
  remarks         String?
}

// ==========================================
// üí∞ FEES & FINANCE
// ==========================================

model FeeCategory {
  id              String         @id @default(cuid())
  name            String         @unique
  description     String?
  feeStructures   FeeStructure[]
}

model FeeStructure {
  id              String       @id @default(cuid())
  classId         String
  categoryId      String
  amount          Decimal      @db.Decimal(10, 2)
  frequency       String       // Monthly, Quarterly, Yearly
  class           Class        @relation(fields: [classId], references: [id])
  category        FeeCategory  @relation(fields: [categoryId], references: [id])
}

// ==========================================
// üì¢ COMMUNICATION
// ==========================================

model Announcement {
  id              String     @id @default(cuid())
  title           String
  content         String     @db.Text
  targetAudience  String?    // ALL, TEACHERS, STAFF, ADMIN
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
}

model Notification {
  id              String           @id @default(cuid())
  title           String
  message         String
  type            NotificationType
  userId          String?
  isRead          Boolean          @default(false)
  createdAt       DateTime         @default(now())
}

model Message {
  id              String     @id @default(cuid())
  senderId        String
  receiverId      String
  subject         String?
  body            String     @db.Text
  isRead          Boolean    @default(false)
  createdAt       DateTime   @default(now())

  @@index([senderId])
  @@index([receiverId])
}

// ==========================================
// üìä SYSTEM & LOGS
// ==========================================

model AuditLog {
  id              String     @id @default(cuid())
  userId          String?
  user            User?      @relation(fields: [userId], references: [id])
  action          String     // e.g., UPDATE, DELETE
  resource        String     // e.g., STAFF, GRADE
  resourceId      String?
  payload         Json?
  ipAddress       String?
  createdAt       DateTime   @default(now())
}

model UserActivityLog {
  id              String     @id @default(cuid())
  userId          String
  user            User       @relation(fields: [userId], references: [id])
  level           LogLevel   @default(INFO)
  event           String
  description     String?
  createdAt       DateTime   @default(now())

  @@index([userId])
}
